/* JavaScript API, amap, AutoNavi Group; */
(function(c){c.PlaceSearch=function(a){this.opt=a||{};this.opt.pageIndex=this.opt.pageIndex||1;this.opt.pageSize="number"!==typeof this.opt.pageSize||0>this.opt.pageSize||100<this.opt.pageSize?10:this.opt.pageSize;this.url="http://restapi.amap.com/v3/place"};c.PlaceSearch.prototype={search:function(a){a?(a=["keywords="+a],a.push("key="+c.Conf.key),this._mergeParams(this.opt,{city:"city",rankBy:"sortrule",type:"types",pageIndex:"page",pageSize:"offset",extensions:"extensions"},a),this._query(this.url+
"/text",a,"KEYWORD")):c.event.trigger(this,"error",{info:"NO_PARAMS"})},searchInBounds:function(a,b){if(a&&b){var d=["keywords="+a,"polygon="+b];d.push("key="+c.Conf.key);this._mergeParams(this.opt,{city:"city",rankBy:"sortrule",type:"types",pageIndex:"page",pageSize:"offset",extensions:"extensions"},d);this._query(this.url+"/polygon",d,"POLYGON")}else c.event.trigger(this,"error",{info:"NO_PARAMS"})},searchNearBy:function(a,b,d){a&&b?(a=["keywords="+a,"location="+b],a.push("key="+c.Conf.key),d&&
a.push("radius="+d),this._mergeParams(this.opt,{city:"city",rankBy:"sortrule",type:"types",pageIndex:"page",pageSize:"offset",extensions:"extensions"},a),this._query(this.url+"/around",a,"NEARBY")):c.event.trigger(this,"error",{info:"NO_PARAMS"})},getDetails:function(a){a?(a=["id="+a],a.push("key="+c.Conf.key),this._query(this.url+"/detail",a,"ID")):c.event.trigger(this,"error",{info:"NO_PARAMS"})},setType:function(a){this.opt.type=a},setPageIndex:function(a){this.opt.pageIndex=a||1},setPageSize:function(a){this.opt.pageSize=
"number"!==typeof a||0>a||100<a?10:a},setCity:function(a){this.opt.city=a},_mergeParams:function(a,b,d){for(var c in a)"undefined"!=typeof a[c]&&"undefined"!=typeof b[c]&&d.push(b[c]+"="+a[c])},_query:function(a,b,d){a+=0<b.length?"?"+b.join("&"):"";a=new c.Http.JSONP(a,{callback:"callback",antiCrab:!0,type_:d});a.on("complete",this._onComplete,this);a.on("error",this._onError,this)},_parseString:function(a){return"object"==typeof a||"undefined"==typeof a?"":a},_formatFields:function(a){for(var b in a)a.hasOwnProperty(b)&&
(a[b]=this._parseString(a[b]))},_str2LngLat:function(a){if(a){var b=a.split(",");return 2===b.length?new c.LngLat(b[0],b[1]):a}return a},_parsePOI:function(a){this._formatFields(a);a.location=this._str2LngLat(a.location);a.entr_location=this._str2LngLat(a.entr_location);a.exit_location=this._str2LngLat(a.exit_location);return a},_parseLngLat:function(a){if(a instanceof Array&&0===a.length)return null;if("string"===typeof a&&0<a.length)return a=a.split(","),new c.LngLat(a[0],a[1])},_onComplete:function(a){var b=
{info:a.info,poiList:{},keywordList:[],cityInfo:[]};if(parseInt(a.status,10)){b.poiList={pois:[],count:parseInt(a.count,10),pageIndex:this.opt.pageIndex,pageSize:this.opt.pageSize};if(a.pois)for(var d=0;d<a.pois.length;d++)b.poiList.pois[d]=this._parsePOI(a.pois[d]);a.suggestion&&a.suggestion.keywords.length&&(b.keywordList=a.suggestion.keywords);if(a.suggestion&&a.suggestion.cities.length){for(var d=a.suggestion.cities,g=[],f=0;f<d.length;f++){city=d[f];for(var e in city)city.hasOwnProperty(e)&&
"num"===e&&(city.count=city[e],delete city[e]);g.push(city)}b.cityList=g}a.count&&0!==parseInt(a.count,10)||(b.info="ok"===a.info.toLowerCase()?"NO_DATA":a.info)}else c.event.trigger(this,"error",{info:a.info});c.event.trigger(this,"complete",b)},_onError:function(a){c.event.trigger(this,"error",{info:"SERVICE_UNAVAILABLE"})}}})(AMap);
